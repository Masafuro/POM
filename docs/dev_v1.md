# POM (Programmable Open Mailbox) 開発ドキュメント - Version 1.1

## 1. システム概要と基本設計
POMは、ユーザーが作成したスクリプト（プラグイン）によってメール処理を自由自在に拡張できるプログラマブルなメールボックスです。本バージョンにおける最大の進展は、受信メールと送信済みメールを単一の `messages` テーブルに統合した「統合データベースモデル」の採用です。これにより、データの流れが一本化され、システム全体の複雑さが大幅に軽減されました。全てのメッセージは、その方向性や状態、拡張情報をメタデータとして保持し、ウェブインターフェースとバックエンドの処理ロジックがそれらを共通のルールで扱う設計となっています。

## 2. データベース設計 (Schema Version 2.0)
データベースには SQLite を採用し、単一の `messages` テーブルが全ての情報を管理します。タグ管理には JSON 配列形式を導入しており、一通のメッセージに対して複数の属性を柔軟に付与することが可能です。

### 主要なカラム構成
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| **uidl** | TEXT (PK) | メッセージを一意識別するID。重複保存を防止します。 |
| **direction** | TEXT | `inbound`（受信）または `outbound`（送信）を識別。 |
| **contact_name** | TEXT | 送信者または宛先の名称。 |
| **contact_address** | TEXT | メールの送受信アドレス。 |
| **subject** | TEXT | メールの件名。 |
| **status** | TEXT | タグ情報を保持するJSON配列（例: `["new", "urgent"]`）。 |
| **meta** | TEXT | 返信先IDやエラー情報などを格納するJSONオブジェクト。 |
| **sent_at** | DATETIME | メールが送信された日時。 |
| **raw_source** | TEXT | メールの生データ（再解析用）。 |

## 3. ウェブインターフェースとHTMLテンプレート
フロントエンドは Flask と Bootstrap 5 を基盤とし、統合されたデータを直感的に操作できる設計になっています。

### ダッシュボード (index.html)
データベース内の全メッセージからタグを動的に集計し、件数付きのタグクラウドを生成します。SQLite の JSON 関数を活用することで、新しいプラグインによって未知のタグが追加された場合でも、プログラムの修正なしで自動的に反映されます。標準タグ（受信、送信、新着）には専用のアイコンと配色が割り当てられています。

### 一覧画面 (list.html)
受信と送信が混在するリストにおいて、`direction` カラムに基づいたアイコン表示により通信の流れを可視化します。青の受信アイコン（📥）と緑の送信アイコン（📤）を使い分けることで判別性を高めています。また、JSON形式のステータスを個別のバッジとしてレンダリングするロジックを搭載しています。

### 詳細画面 (detail.html)
メッセージの閲覧と返信の起点を兼ねた画面です。基本情報に加え、`meta` カラムに格納された拡張データのプレビュー機能を備えています。本文表示エリアは改行を保持するスタイルで構成され、下部には宛先や件名が自動入力される返信フォームが統合されています。

## 4. リアクティブ・プラグインシステム
バックエンドでは `main.py` が司令塔となり、一定間隔でサイクルを実行します。

1. **Intakeステージ**: `intake.py` が POP3 サーバーからメールを取得し、初期ステータス `["new"]` と方向 `inbound` を付与して保存します。
2. **Reactiveステージ**: `reactive` ディレクトリ内のプラグインが順次実行されます。実証段階では `02_addrandtag.py` によって新着メールが `inbox1` と `inbox2` へ自動で振り分けられる動作を確立しました。

## 5. 管理・運用ツール群
システムのメンテナンスを支える以下のツールが `core` ディレクトリに整備されています。

- **make_db.py**: 統合テーブル `messages` の構築と初期インデックスの作成。
- **check_db.py**: スキーマバージョン、構造、方向別の件数レポートを出力。
- **dump_db.py**: ターミナル上でメッセージ内容とステータスを一覧表示。
- **clear_db.py**: 設定情報を保護しつつ、メッセージデータのみを安全に削除。